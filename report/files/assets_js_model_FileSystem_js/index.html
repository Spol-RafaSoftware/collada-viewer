<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title></title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap-3.0.0-wip.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome-ie7.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="brand" href="http://github.com/jsoverson/plato">Plato on Github</a>
    <ul class="nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>assets/js/model/FileSystem.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="span6">
      <h2 class="header">Maintainability</h2>
      <p class="stat">127.19</p>
    </div>
    <div class="span6">
      <h2 class="header">Estimated # Bugs</h2>
      <p class="stat">1.47</p>
    </div>
  </div>
  <div class="row">
    <div class="span6">
      <h2 class="header">Difficulty</h2>
      <p class="stat">39.80</p>
    </div>
    <div class="span6">
      <h2 class="header">SLOC/LSLOC</h2>
      <p class="stat">228 / 104</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="span6">
      <h3 class="chart-header">By Complexity</h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="span6">
      <h3 class="chart-header">By SLOC</h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="span12">/** @file FileSystem.js
 *  @fileOverview Model for File System API.
 *  @author cs_brandt
 *  @date 10/20/2012 
 */


define(['jquery', 'underscore', 'backbone', 'model/File'], function($, _, Backbone, File)
{
   var FilesCollection = Backbone.Collection.extend(
   {
      model: File,

      initialize: function()
      {

      	
      },

      // overrides add to take a FileList
      // and add each file in the FileList
      // as an individual model in the collection
      add: function(fileList)
      {
         for (var c = 0; c < fileList.length; c++)
         {
            Backbone.Collection.prototype.add.call(this, { file: fileList[c] });
         }
      }

   });

   var FileSystem = Backbone.Model.extend(
   {
      defaults:
      {
         files: new FilesCollection()
      },

      initialize: function()
      {
         // Note: The file system has been prefixed as of Google Chrome 12:
         window.requestFileSystem  = window.requestFileSystem || window.webkitRequestFileSystem;

         window.webkitStorageInfo.requestQuota(PERSISTENT, 100 * 1024 * 1024, function(grantedBytes)
         {
            window.requestFileSystem(PERSISTENT, grantedBytes, this.initFS.bind(this), this.FSErrorHandler.bind(this));

         }.bind(this));

         // bind fs initialization
         // to fetch files into files collection
         this.bind("change:fs", function()
         {
            this.getAll();

         }, this);

         this.get("files").bind("add", function(model)
         {
            var file = model.get("file");

            // if the entry being added
            // is not in the filesystem
            if (!file.filesystem)
            {
               this.createFile(model);
            }

         }, this);

      },

      add: function(fileList)
      {
         this.get("files").add(fileList);
      },

      initFS: function(fs)
      {
         // save the reference to the DOMFileSystem object
         // as an attribute on this model
         this.set("fs", fs);
         this.updateUsageAndQuota();

         console.log('Opened file system: ' + fs.name);
      },

      getAll: function()
      {
         var fs = this.get("fs");

         var dirReader = fs.root.createReader();

         dirReader.readEntries(function(entries) 
         {
            this.add(entries);
      
         }.bind(this), this.FSErrorHandler);

      },

      FSErrorHandler: function(error)
      {
         var msg = '';

         switch (error.code) 
         {
            case FileError.QUOTA_EXCEEDED_ERR:
               msg = 'QUOTA_EXCEEDED_ERR';
               break;

            case FileError.NOT_FOUND_ERR:
               msg = 'NOT_FOUND_ERR';
               break;

            case FileError.SECURITY_ERR:
               msg = 'SECURITY_ERR';
               break;

            case FileError.INVALID_MODIFICATION_ERR:
               msg = 'INVALID_MODIFICATION_ERR';
               break;

            case FileError.INVALID_STATE_ERR:
               msg = 'INVALID_STATE_ERR';
               break;

            default:
               msg = 'Unknown Error';
               break;
         }

         console.log('Error: ' + msg);
      },

      createFile: function(model)
      {
         var file = model.get("file");
         var fs   = this.get("fs");

         fs.root.getFile(file.name, {create: true, exclusive: false}, function(fileEntry) 
         {
            fileEntry.createWriter(function(fileWriter) 
            {
               fileWriter.write(file);
               this.updateUsageAndQuota();

            }.bind(this), this.FSErrorHandler);

         }.bind(this), this.FSErrorHandler); 
      },

      deleteFile: function(path)
      {
         var files = this.get("files");
         var fs    = this.get("fs");

         // find the model represented by path
         // remove model from collection, delete from filesystem
         files.all(function(model)
         {
            var file = model.get("file");

            if (file.fullPath === path)
            {
               files.remove(model);

               // delete from fs
               fs.root.getFile(file.fullPath, {create: false}, function(fileEntry) 
               {
                  fileEntry.remove(function() 
                  {
                     console.log(file.fullPath + ' deleted.');
                     this.updateUsageAndQuota();

                  }.bind(this), this.FSErrorHandler);

               }.bind(this), this.FSErrorHandler);

               // break
               return false;
            }

            return true;

         }.bind(this));

      },

      openFile: function(path)
      {
         var fs   = this.get("fs");

         fs.root.getFile(path, {}, function(fileEntry)
         {
            fileEntry.file(function(file)
            {
               this.set("openedFile", file);

            }.bind(this), this.FSErrorHandler);

         }.bind(this), this.FSErrorHandler);
      },

      moveFile: function(path, newPath)
      {
         var fs   = this.get("fs");

         fs.root.getFile(path, {}, function(fileEntry)
         {
            fileEntry.moveTo(fs.root, newPath);

         }.bind(this), this.FSErrorHandler);
      },

      updateUsageAndQuota: function()
      {
         window.webkitStorageInfo.queryUsageAndQuota(webkitStorageInfo.PERSISTENT, function(used, remaining)
         {
            this.set("quota", 
            {
               used: used,
               remaining: remaining

            });

         }.bind(this), this.FSErrorHandler);
      }

   });

   return FileSystem;

});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>

</body>
</html>
